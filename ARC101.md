# Monitor and Manage Google Cloud Resources: Challenge Lab

---

## Task 1. Create a bucket

#### 1. Create a bucket named <BUCKET_NAME> in region <REGION> for the storage of the photographs.

```bash
export REGION=<REGION>
```

```bash
export BUCKET_NAME=<BUCKET_NAME>
```

```bash
gsutil mb -l $REGION gs://$BUCKET_NAME
```

#### 2. Grant Storage Object Viewer to <USER_2> on the project containing this new bucket.

---

## Task 2. Create a Pub/Sub topic

#### 1. Create a Pub/Sub topic called <TOPIC_NAME> for the Cloud Run Function to send messages.

```bash
export TOPIC_NAME=<TOPIC_NAME>
```

```bash
gcloud pubsub topics create $TOPIC_NAME
```

---

## Task 3. Create the thumbnail Cloud Run Function

#### Note: You must upload one JPG or PNG image into the bucket to verify the thumbnail was created (after creating the function successfully). Use this image https://storage.googleapis.com/cloud-training/arc101/travel.jpg; download the image to your machine and then upload that file to your bucket.

#### Download an image file named wildlife.jpg from the given URL.

```bash
wget https://storage.googleapis.com/cloud-training/arc101/travel.jpg
```

#### Upload the image travel.jpg to the Cloud Storage bucket that was created earlier

```bash
gsutil cp travel.jpg gs://$BUCKET_NAME
```

#### Enable Required Services

```bash
gcloud services enable \
  artifactregistry.googleapis.com \
  cloudfunctions.googleapis.com \
  cloudbuild.googleapis.com \
  eventarc.googleapis.com \
  run.googleapis.com \
  logging.googleapis.com \
  pubsub.googleapis.com
```

#### Set Project Variables

```bash
export PROJECT_ID=$(gcloud config get-value project)
```

```bash
PROJECT_NUMBER=$(gcloud projects list --filter="project_id:$PROJECT_ID" --format='value(project_number)')
```

```bash
SERVICE_ACCOUNT=$(gsutil kms serviceaccount -p $PROJECT_NUMBER)
```

#### Assign Pub/Sub Publisher Role

```bash
gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member serviceAccount:$SERVICE_ACCOUNT \
 --role roles/pubsub.publisher
```

#### 1. Create a Cloud Run Function (2nd generation) called <CLOUD_RUN_FUNCTION_NAME> (using Node.js 22) that executes every time an object is created in the bucket <BUCKET_NAME> you created in task 1.

#### 2. Make sure you set the Entry point (Function to execute) to thumbnail and Trigger to Cloud Storage.

#### 3.a. Add provided lab code to the index.js. In line 15 of index.js replace the text REPLACE_WITH_YOUR_TOPIC ID with the <TOPIC_NAME> you created in task 2.

```bash
nano index.js
```

#### 3.b. Add provided lab code to the package.json.

```bash
nano package.json
```

#### Deploy the Function

```bash
export CLOUD_RUN_FUNCTION_NAME=<CLOUD_RUN_FUNCTION_NAME>
```

```bash
gcloud functions deploy $CLOUD_RUN_FUNCTION_NAME \
 --gen2 \
 --runtime nodejs22 \
 --entry-point thumbnail \
 --source . \
 --region $REGION \
 --trigger-bucket $BUCKET_NAME \
 --allow-unauthenticated \
 --trigger-location $REGION \
 --max-instances 5 \
 --quiet
```

#### If you see the following error:

**ERROR**:`(gcloud.functions.deploy) ResponseError: status=[403], code=[Ok], message=[Validation failed for trigger projects/qwiklabs-gcp-04-0a6a1d28c7e3/locations/us-east1/triggers/wild-thumbnail-creator-483033: Permission "storage.buckets.get" denied on "Bucket \"wild-bucket-qwiklabs-gcp-04-0a6a1d28c7e3\" could not be validated. Please verify that the bucket exists and that the Eventarc service account has permission."]`

or

**ERROR**:`(gcloud.functions.deploy) ResponseError: status=[400], code=[Ok], message=[Validation failed for trigger projects/qwiklabs-gcp-01-822619484359/locations/us-east4/triggers/travel-thumbnail-maker-167346: Invalid resource state for "": Permission denied while using the Eventarc Service Agent. If you recently started to use Eventarc, it may take a few minutes before all necessary permissions are propagated to the Service Agent. Otherwise, verify that it has Eventarc Service Agent role.]`

It means the deployment failed because the Eventarc service account does not yet have permission to access your Cloud Storage bucket, or the bucket validation process hasnâ€™t completed.

#### Solution:

Wait for a few seconds to let the permissions propagate, then run the deployment command again.

---

## Task 4. Create an alerting policy

#### 1. Create an alerting policy named Active Cloud Run Function Instances that notifies your personal email account when the number of active Cloud Run Function instances is greater than zero (0).

#### 2. For the metric, be sure to select Cloud Function > Function > Active Instances.

#### Use Cloud Monitoring to create alerting policies.

**Step 1**. In the left menu, click **Alerting**, and then click **+Create Policy**.

**Step 2**. Click on **Select a metric** dropdown. Uncheck the **Active**.

    Step 3. For the metric, be sure to select "Cloud Function > Function > Active Instances" and click Apply. Leave all other fields at the default value.
    Step 4. Click Next.
    Step 5. Set the "Threshold position" to "Above threshold", Threshold value to 1 (number of active Cloud Run Function instances is greater than zero). Click Next.
    Step 6. Click on the drop down arrow next to "Notification Channels", then click on "Manage Notification Channels".

#### A Notification channels page will open in a new tab.

    Step 7. Scroll down the page and click on "ADD NEW" for "Email".
    Step 8. In the "Create Email Channel" dialog box, enter your personal email address in the "Email Address" field and a "Display name".
    Step 9. Click on Save.
    Step 10. Go back to the previous "Create alerting policy" tab.
    Step 11. Click on "Notification Channels" again, then click on the "Refresh icon" to get the display name you mentioned in the previous step.
    Step 12. Click on "Notification Channels" again if necessary, select your "Display name" and click OK.
    Step 13. Mention the "Alert name" as "Active Cloud Run Function Instances".
    Step 14. Click Next.
    Step 15. Review the alert and click "Create Policy".
