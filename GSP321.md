# Develop your Google Cloud Network: Challenge Lab

## Task 1. Create development VPC manually

#### Create a VPC called griffin-dev-vpc with the following subnets only:

> griffin-dev-wp, IP address block: 192.168.16.0/20

> griffin-dev-mgmt, IP address block: 192.168.32.0/20

```bash
export REGION=us-east1
```

```bash
gcloud compute networks create griffin-dev-vpc --subnet-mode custom
```

```bash
gcloud compute networks subnets create griffin-dev-wp --network=griffin-dev-vpc --region $REGION --range=192.168.16.0/20
```

```bash
gcloud compute networks subnets create griffin-dev-mgmt --network=griffin-dev-vpc --region $REGION --range=192.168.32.0/20
```

---

## Task 2. Create production VPC manually

#### Create a VPC called griffin-prod-vpc with the following subnets only:

> griffin-prod-wp, IP address block: 192.168.48.0/20

> griffin-prod-mgmt, IP address block: 192.168.64.0/20

```bash
gcloud compute networks create griffin-prod-vpc --subnet-mode custom
```

```bash
gcloud compute networks subnets create griffin-prod-wp --network=griffin-prod-vpc --region $REGION --range=192.168.48.0/20
```

```bash
gcloud compute networks subnets create griffin-prod-mgmt --network=griffin-prod-vpc --region $REGION --range=192.168.64.0/20
```

---

## Task 3. Create bastion host

#### Create a bastion host with two network interfaces, one connected to griffin-dev-mgmt and the other connected to griffin-prod-mgmt. Make sure you can SSH to the host.

```bash
export ZONE=us-east1-d
```

```bash
gcloud compute instances create bastion --network-interface=network=griffin-dev-vpc,subnet=griffin-dev-mgmt --network-interface=network=griffin-prod-vpc,subnet=griffin-prod-mgmt --tags=ssh --zone=$ZONE
```

```bash
gcloud compute firewall-rules create fw-ssh-dev --source-ranges=0.0.0.0/0 --target-tags ssh --allow=tcp:22 --network=griffin-dev-vpc
```

```bash
gcloud compute firewall-rules create fw-ssh-prod --source-ranges=0.0.0.0/0 --target-tags ssh --allow=tcp:22 --network=griffin-prod-vpc
```

---

## Task 4. Create and configure Cloud SQL Instance

#### 1. Create a MySQL Cloud SQL Instance called griffin-dev-db in us-west1.

```bash
gcloud sql instances create griffin-dev-db \
  --database-version=MYSQL_8_0 \
  --region=$REGION \
  --root-password='1234567890'
```

#### 2. Connect to the instance and run the provided SQL commands to prepare the WordPress environment.

```bash
gcloud sql connect griffin-dev-db --user=root --quiet
```

---

## Task 5. Create Kubernetes cluster

#### Create a 2 node cluster (e2-standard-4) called griffin-dev, in the griffin-dev-wp subnet, and in zone us-east1-d.

```bash
gcloud container clusters create griffin-dev \
  --network griffin-dev-vpc \
  --subnetwork griffin-dev-wp \
  --machine-type e2-standard-4 \
  --num-nodes 2 \
  --zone $ZONE
```

---

## Task 6. Prepare the Kubernetes cluster

#### 1. From Cloud Shell copy all files from gs://spls/gsp321/wp-k8s.

```bash
gsutil cp -r gs://spls/gsp321/wp-k8s .
```

#### The WordPress server needs to access the MySQL database using the username and password you created in task 4.

#### 2. You do this by setting the values as secrets. WordPress also needs to store its working files outside the container, so you need to create a volume.

```bash
cd wp-k8s
```

#### 3. Add the following secrets and volume to the cluster using wp-env.yaml.

```bash
nano wp-env.yaml
```

#### 4. Make sure you configure the username to wp_user and password to stormwind_rules before creating the configuration.

```bash
kubectl create -f wp-env.yaml
```

#### You also need to provide a key for a service account that was already set up. This service account provides access to the database for a sidecar container.

#### 5. Use the provided command to create the key, and then add the key to the Kubernetes environment.

---

## Task 7. Create a WordPress deployment

#### Now that you have provisioned the MySQL database, and set up the secrets and volume, you can create the deployment using wp-deployment.yaml.

#### 1. Before you create the deployment you need to edit wp-deployment.yaml.

```bash
nano wp-deployment.yaml
```

#### 2. Replace YOUR_SQL_INSTANCE with griffin-dev-db's Instance connection name.

#### 3. Get the Instance connection name from your Cloud SQL instance.

#### 4. After you create your WordPress deployment, create the service with wp-service.yaml.

```bash
kubectl create -f wp-deployment.yaml
```

```bash
kubectl create -f wp-service.yaml
```

#### 5. Once the Load Balancer is created, you can visit the site and ensure you see the WordPress site installer.

```bash
export WP_EXTERNAL_IP=$(kubectl get service wordpress -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
echo $WP_EXTERNAL_IP
```

---

## Task 8. Enable monitoring

#### Create an uptime check for your WordPress development site.

```bash
gcloud monitoring uptime create quicklab \
  --resource-type=uptime-url \
  --resource-labels=host=$WP_EXTERNAL_IP
```

---

## Task 9. Provide access for an additional engineer

#### You have an additional engineer starting and you want to ensure they have access to the project. Grant them the editor role to the project.

#### The second user account for the lab represents the additional engineer.
