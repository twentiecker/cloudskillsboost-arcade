# Store, Process, and Manage Data on Google Cloud - Command Line: Challenge Lab

---

## Task 1. Create a bucket

#### 1. Use commands (CLI/SDK) to create a bucket called <BUCKET_NAME> for the storage of the photographs.

```bash
export REGION=<REGION>
```

```bash
export BUCKET_NAME=<BUCKET_NAME>
```

```bash
gsutil mb -l $REGION gs://$BUCKET_NAME
```

---

## Task 2. Create a Pub/Sub topic

#### 1. Use the command line to create a Pub/Sub topic called <TOPIC_NAME> for the Cloud Function to send messages.

```bash
export TOPIC_NAME=<TOPIC_NAME>
```

```bash
gcloud pubsub topics create $TOPIC_NAME
```

---

## Task 3. Create the thumbnail Cloud Function

#### Note: You must upload one JPG or PNG image into the bucket to verify the thumbnail was created (after creating the function successfully). Use this image https://storage.googleapis.com/cloud-training/arc102/wildlife.jpg; download the image to your machine and then upload that file to your bucket. You will see a thumbnail image appear shortly afterwards (use REFRESH in the bucket details).

#### Download an image file named wildlife.jpg from the given URL.

```bash
wget https://storage.googleapis.com/cloud-training/arc102/wildlife.jpg
```

#### Upload the image wildlife.jpg to the Cloud Storage bucket that was created earlier

```bash
gsutil cp wildlife.jpg gs://$BUCKET_NAME
```

#### Enable Required Services

```bash
gcloud services enable \
  artifactregistry.googleapis.com \
  cloudfunctions.googleapis.com \
  cloudbuild.googleapis.com \
  eventarc.googleapis.com \
  run.googleapis.com \
  logging.googleapis.com \
  pubsub.googleapis.com
```

#### Set Project Variables

```bash
export PROJECT_ID=$(gcloud config get-value project)
```

```bash
PROJECT_NUMBER=$(gcloud projects list --filter="project_id:$PROJECT_ID" --format='value(project_number)')
```

```bash
SERVICE_ACCOUNT=$(gsutil kms serviceaccount -p $PROJECT_NUMBER)
```

#### Assign Pub/Sub Publisher Role

```bash
gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member serviceAccount:$SERVICE_ACCOUNT \
 --role roles/pubsub.publisher
```

#### 1. Use the command line to create a Cloud Function called <CLOUD_FUNCTION_NAME> that executes every time an object is created in the bucket <BUCKET_NAME> you created in task 1.

#### 2. Make sure you set the Entry point (Function to execute) to thumbnail and Trigger to Cloud Storage.

#### 3.a. Add provided lab code to the index.js. In line 15 of index.js replace the text REPLACE_WITH_YOUR_TOPIC ID with the <TOPIC_NAME> you created in task 2.

```bash
nano index.js
```

#### 3.b. Add provided lab code to the package.json.

```bash
nano package.json
```

#### Deploy the Function

```bash
export CLOUD_FUNCTION_NAME=<CLOUD_FUNCTION_NAME>
```

```bash
gcloud functions deploy $CLOUD_FUNCTION_NAME \
 --gen2 \
 --runtime nodejs20 \
 --entry-point thumbnail \
 --source . \
 --region $REGION \
 --trigger-bucket $BUCKET_NAME \
 --allow-unauthenticated \
 --trigger-location $REGION \
 --max-instances 5 \
 --quiet
```
