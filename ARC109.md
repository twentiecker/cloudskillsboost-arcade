# Getting Started with API Gateway: Challenge Lab

## Task 1. Create a Cloud Run function

#### Note: Cloud Run functions (2nd gen) depend on the Cloud Run Admin APIs. The Cloud Run Admin APIs have been enabled for you at the start of this lab. It may however take a few minutes for all of the enabled services to propagate. If you experience an issue when deploying your Cloud Run function, wait a few minutes then try again.

#### Create a new Cloud Run function (2nd gen) called gcfunction in the <REGION> region using Node.js 22 and allowing unauthenticated invocations. For now, simply have the function return "Hello World!" when invoked.

> Open Cloud Run Functions in the Google Cloud Console.

> Click Create Function.

> Set the function by following lab instructions

> Click Create and then Click Save and Redeploy

---

## Task 2. Create an API Gateway

#### Once the Cloud Run function is deployed, configure an API Gateway to proxy requests to the backend.

#### Create a file named openapispec.yaml (using the provided lab code), which references the Cloud Run function deployed in Task 1.

```bash
nano openapispec.yaml
```

#### Use openapispec.yaml when deploying the API Gateway with the following properties:

**Display Name**: `gcfunction API (wherever requested)`

**API ID**: `gcfunction-api`

**Select a service account**: `Compute Engine default service account`

**Location**: `<REGION>`

**Config Name**: `gcfunction-api`

> Open API Gateway in the Google Cloud Console.

> Enable the API Gateway API if itâ€™s not already enabled.

> Click Create Gateway.

> Fill in the required properties as instructed.

> Run the following command to generate a unique API ID:

```bash
export API_ID="gcfunction-api-$(cat /dev/urandom | tr -dc 'a-z' | fold -w ${1:-8} | head -n 1)"
echo $API_ID
```

> Use the value of $API_ID for both the Display Name and the API ID fields when creating the gateway.

> Download the openapispec.yaml file by running:

```bash
cloudshell download $HOME/openapispec.yaml
```

> In the Gateway Details, set the Display Name to: gcfunction-api

---

## Task 3. Create a Pub/Sub Topic and Publish Messages via API Backend

#### The development team would like the API backend to publish messages to a new Pub/Sub topic named demo-topic.

#### Create a new Pub/Sub topic (demo-topic) and push messages to it in the Cloud Run function deployed earlier. Be sure to keep the option to create a default subscription enabled when creating the topic.

> Go to Pub/Sub in the Google Cloud Console.

> Click Create Topic.

> For the Name, enter: demo-topic.

> Leave all other settings as default.

> Click Create.

#### Use the provided lab code to update the package.json file and index.js code in the Cloud Run function deployed in Task 1.

#### Redeploy the Cloud Run function once the index.js and package.json files have been updated.

#### Next, invoke the Cloud Run function via API Gateway. If done correctly, a message will be published to the topic demo-topic you've created in this task.
