# Monitoring in Google Cloud: Challenge Lab

## Task 1. Install the Cloud Logging and Monitoring agents

#### So for this task, you need to install the Cloud Logging and Cloud Monitoring agents.

#### 1. Connect to the VM instance apache-vm provisioned for you via SSH and install the Cloud Logging and Cloud Monitoring agents.

```bash
curl -sSO https://dl.google.com/cloudagents/add-logging-agent-repo.sh
sudo bash add-logging-agent-repo.sh --also-install
```

```bash
curl -sSO https://dl.google.com/cloudagents/add-monitoring-agent-repo.sh
sudo bash add-monitoring-agent-repo.sh --also-install
```

#### 2. Enable the Apache Web Server monitoring plugin using the provided lab code:

---

## Task 2. Add an uptime check for Apache Web Server on the VM

#### For this task, you need to verify that your VM is up and running. To do this, create an uptime check with the resource type set to instance.

> **Step 1**. In the Cloud Console, in the left menu, click **Uptime checks**, and then click **Create Uptime Check**.

> **Step 2**. For **Protocol**, select **HTTP**.

> **Step 3**. For **Resource Type**, select **Instance**.

> **Step 4**. For **Instance**, select **apache-vm**.

> **Step 5**. For **Check Frequency**, select **1 minute**.

> **Step 6**. Click **Continue**.

> **Step 7**. In Response Validation, accept the defaults and then click **Continue**.

> **Step 8**. In Alert & Notification, accept the defaults, and then click **Continue**.

> **Step 9**. Name the **Title**.

> **Step 10**. Click **Test** to verify that your uptime check can connect to the resource. When you see a green check mark everything can connect.

> **Step 11**. Click **Create**. The uptime check you configured takes a while for it to become active. Continue with the lab, you'll check for results later. While you wait, create an alerting policy for a different resource.

---

## Task 3. Add an alert policy for Apache Web Server

#### 1. Create an alert policy for Apache Web Server traffic that notifies you on your personal email account when the traffic rate exceeds 3 KiB/s.

> **Step 1**. In the left menu, click **Alerting**, and then click **+Create Policy**.

> **Step 2**. Click on **Select a metric** dropdown. Uncheck the **Active**.

> **Step 3**. For the metric, be sure to select **VM Instance > apache > Traffic** and click **Apply**. Leave all other fields at the default value.

> **Step 4**. Click **Next**.

> **Step 5**. Set the **Threshold position** to `Above threshold`, **Threshold value** to `3072` (traffic rate exceeds 3 KiB/s). Click **Next**.

> **Step 6**. Click on the drop down arrow next to **Notification Channels**, then click on **Manage Notification Channels**.

#### A Notification channels page will open in a new tab.

> **Step 7**. Scroll down the page and click on **ADD NEW** for **Email**.

> **Step 8**. In the **Create Email Channel** dialog box, enter your personal email address in the **Email Address** field and a **Display name**.

> **Step 9**. Click on **Save**.

> **Step 10**. Go back to the previous **Create alerting policy** tab.

> **Step 11**. Click on **Notification Channels** again, then click on the **Refresh icon** to get the display name you mentioned in the previous step.

> **Step 12**. Click on **Notification Channels** again if necessary, select your **Display name** and click **OK**.

> **Step 13**. Mention the **Alert name** as **qwiklab**.

> **Step 14**. Click **Next**.

> **Step 15**. Review the alert and click **Create Policy**.

#### 2. Connect to the instance via SSH and run the provided lab command to generate the traffic.

#### 3. Monitor the alert policy that you just created once the traffic rate exceeds 3 KiB/s you should receive an alert on your email id.

---

## Task 4. Create a dashboard and charts for Apache Web Server on the VM

#### For this task, you need to create a dashboard that's configured with charts.

> **Step 1**. In the left menu select Dashboards, and then +Create Custom Dashboard.

> **Step 2**. Name the dashboard.

#### 1. Add the first line chart that has a Resource metric filter, CPU load (1m), for the VM.

> **Step 1**. Click on **+ ADD WIDGET**

> **Step 2**. Select the **Line** option under **Visualization** in the **Add widget**.

> **Step 3**. Name the Widget title.

> **Step 4**. Click on **Select a metric** dropdown. Uncheck the **Active**.

> **Step 5**. **Type CPU load (1m)** in filter by resource and metric name and click on **VM instance > Cpu**. Select `CPU load (1m)` and click **Apply**. Leave all other fields at the default value. Refresh the tab to view the graph.

#### 2. Add a second line chart that has a Resource metric filter, Requests, for Apache Web Server.

> **Step 1**. Click +** Add WIDGET** and select **Line** option under **Visualization** in the **Add widget**.

> **Step 2**. Name the **Widget title**.

> **Step 3**. Click on **Select a metric** dropdown. Uncheck the **Active**.

> **Step 4**. Type **Requests** in filter by resource and metric name and click on **VM Instance > apache**. Select `Requests` and click **Apply**. Leave all other fields at the default value. Refresh the tab to view the graph.

---

## Task 5. Create a log-based metric

#### 1. Next, create a log based metric that filters for the following values:

**Resource type**: VM
**Logname**: apache-access
**Text Payload**: textPayload:"200"

#### Now you'll create a Distribution type logs based metric to extract the value of textPayload from the log entries textPayload.

> **Step 1**. Select **Navigation menu > Logging > Logs Explorer**.

> **Step 2**. Select the logs you want to see, in this case, you select the logs for the following values:

**Resource type**: `VM`

Click on **All Resources** > Select **VM Instance** in the **Resource** drop-down menu > Click **Apply**.

**Logname**: `apache-access`

Click on **All Log Names** > Select **apache-access** in the **Log Names** drop-down menu > Click **Apply**.

**Text Payload**: `textPayload:"200"`

Add **textPayload:"200"** to the query.

> **Step 3**. Click **Run query**.

> **Step 4**. In **Actions** dropdown click **Create metric**.

#### In the Create log-based metric form:

> **Step 5**. Change the **Metric Type** to **Distribution**.

> **Step 6**. Name the **Log-based metric name**.

> **Step 7**. Enter **textPayload** for Field name.

> **Step 8**. Click **Create metric**.
